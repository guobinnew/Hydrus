"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Task=exports.Service=exports.Decorator=exports.Behavior=exports.BehaviorStatus=void 0;var _logger=_interopRequireDefault(require("./logger")),_utils=_interopRequireDefault(require("./utils"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _get(t,e,r){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,r){var i=_superPropBase(t,e);if(i){var n=Object.getOwnPropertyDescriptor(i,e);return n.get?n.get.call(r):n.value}})(t,e,r||t)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}var BehaviorStatus={Idle:-1,Failure:0,Success:1,Running:2};exports.BehaviorStatus=BehaviorStatus;var Behavior=function(){function v(t,e,r){if(_classCallCheck(this,v),this.parent=t,this.status=BehaviorStatus.Idle,e){if(this.config=e,this.convert(r,e),this.decorators=[],this.services=[],e.elements){var i=!0,n=!1,o=void 0;try{for(var a,s=e.elements[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var u=a.value;"decorator"===u.type?this.decorators.push(new Decorator(this,u,r)):"service"===u.type&&this.services.push(new Service(this,u,r))}}catch(t){n=!0,o=t}finally{try{i||null==s.return||s.return()}finally{if(n)throw o}}}if(this.children=[],e.children){var c=!0,l=!1,h=void 0;try{for(var f,p=e.children[Symbol.iterator]();!(c=(f=p.next()).done);c=!0){var _=f.value;"task"===_.type?this.children.push(new Task(this,_,r)):this.children.push(new Composite(this,_,r))}}catch(t){l=!0,h=t}finally{try{c||null==p.return||p.return()}finally{if(l)throw h}}}}else _logger.default.error("Behavior::constructor error -- config is null")}return _createClass(v,[{key:"update",value:function(t){var e=!0,r=!1,i=void 0;try{for(var n,o=this.decorators[Symbol.iterator]();!(e=(n=o.next()).done);e=!0){if(n.value.update(t)!==BehaviorStatus.Success)return BehaviorStatus.Failure}}catch(t){r=!0,i=t}finally{try{e||null==o.return||o.return()}finally{if(r)throw i}}var a=!0,s=!1,u=void 0;try{for(var c,l=this.services[Symbol.iterator]();!(a=(c=l.next()).done);a=!0){c.value.update(t)}}catch(t){s=!0,u=t}finally{try{a||null==l.return||l.return()}finally{if(s)throw u}}return BehaviorStatus.Success}},{key:"reset",value:function(){this.status=BehaviorStatus.Idle;var t=!0,e=!1,r=void 0;try{for(var i,n=this.decorators[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){i.value.reset()}}catch(t){e=!0,r=t}finally{try{t||null==n.return||n.return()}finally{if(e)throw r}}var o=!0,a=!1,s=void 0;try{for(var u,c=this.services[Symbol.iterator]();!(o=(u=c.next()).done);o=!0){u.value.reset()}}catch(t){a=!0,s=t}finally{try{o||null==c.return||c.return()}finally{if(a)throw s}}var l=!0,h=!1,f=void 0;try{for(var p,_=this.children[Symbol.iterator]();!(l=(p=_.next()).done);l=!0){p.value.reset()}}catch(t){h=!0,f=t}finally{try{l||null==_.return||_.return()}finally{if(h)throw f}}}},{key:"convert",value:function(t,e){if(this.__func__=null,t){if(e.actor){var r=null,i={};if(_utils.default.common.isString(e.actor))i={id:e.actor};else{if(!_utils.default.common.isObject(e.actor)||!_utils.default.common.isString(i.id))return void _logger.default.error("Behavior::bind failed -- config.actor is invalid");i=e.actor}if("decorator"===e.type)r=t.$decorators[i.id];else if("service"===e.type)r=t.$services[i.id];else{if("task"!==e.type)return;r=t.$tasks[i.id]}this.__func__=r.bind(t.$blackboard.data())}}else _logger.default.error("Behavior::bind failed -- context is null")}}]),v}();exports.Behavior=Behavior;var Decorator=function(t){function i(t,e,r){return _classCallCheck(this,i),_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,t,e,r))}return _inherits(i,Behavior),_createClass(i,[{key:"update",value:function(t){var e=BehaviorStatus.Success;if(this.__func__){var r=[t].concat(this.config.actor.params?this.config.actor.params:[]);e=this.__func__.apply(r)}return!0===this.config.invert?!e:e}}]),i}();exports.Decorator=Decorator;var Service=function(t){function i(t,e,r){return _classCallCheck(this,i),_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,t,e,r))}return _inherits(i,Behavior),_createClass(i,[{key:"update",value:function(t){if(this.__func__){var e=[t].concat(this.config.actor.params?this.config.actor.params:[]);this.__func__.apply(e)}}}]),i}();exports.Service=Service;var Composite=function(t){function n(t,e,r){var i;return _classCallCheck(this,n),(i=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this,t,e,r))).isComposite=!0,i.lastRunning=-1,i.__cache__=[],i}return _inherits(n,Behavior),_createClass(n,[{key:"update",value:function(t){var e=_get(_getPrototypeOf(n.prototype),"update",this).call(this,t);return e!==BehaviorStatus.Success||0<this.children.length&&(e="selector"===this.config.type?this.updateSelector(t):"sequence"===this.config.type?this.updateSequence(t):"parallel"===this.config.type?this.updateParallel(t):BehaviorStatus.Error),e}},{key:"updateSelector",value:function(t){var e=BehaviorStatus.Success,r=0<=this.lastRunning?this.lastRunning:0;for(this.lastRunning=-1,r=this.lastRunning;r<this.children.length;r++)if((e=this.children[r].update(t))!==BehaviorStatus.Failure){if(e===BehaviorStatus.Success)break;if(e===BehaviorStatus.Running){this.lastRunning=r;break}}return e}},{key:"updateSequence",value:function(t){var e=BehaviorStatus.Success,r=0<=this.lastRunning?this.lastRunning:0;for(this.lastRunning=-1,r=this.lastRunning;r<this.children.length&&(e=this.children[r].update(t))!==BehaviorStatus.Failure;r++)if(e!==BehaviorStatus.Success&&e===BehaviorStatus.Running){this.lastRunning=r;break}return e}},{key:"updateParallel",value:function(t){var e=BehaviorStatus.Success,r=this.config.threshold?Number(this.config.threshold):-1;r<0&&(r=this.children.length),r=_utils.default.lodash.clamp(r,0,this.children.length);for(var i=0,n=0,o=0;o<this.children.length;o++)null!=this.__cache__[o]&&this.__cache__[o]!==BehaviorStatus.Running||(e=this.children[o].update(t),(this.__cache__[o]=e)===BehaviorStatus.Running&&n++),this.__cache__[o]===BehaviorStatus.Success&&i++;return e=0===n?i===r?BehaviorStatus.Success:BehaviorStatus.Failure:BehaviorStatus.Running}},{key:"reset",value:function(){_get(_getPrototypeOf(n.prototype),"reset",this).call(this),this.lastRunning=-1,this.__cache__=[]}}]),n}(),Task=function(t){function i(t,e,r){return _classCallCheck(this,i),_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,t,e,r))}return _inherits(i,Behavior),_createClass(i,[{key:"update",value:function(t){_logger.default.debug("Execute Task -- ".concat(this.config.actor));var e=_get(_getPrototypeOf(i.prototype),"update",this).call(this,t);if(e!==BehaviorStatus.Success)return e;if(e=BehaviorStatus.Success,this.__func__){var r=[t].concat(this.config.actor.params?this.config.actor.params:[]);e=this.__func__.apply(r)}return e}}]),i}();exports.Task=Task;